const t={leftKey:65,upKey:87,rightKey:68,downKey:83,aKey:"K".charCodeAt(),bKey:"J".charCodeAt()},e={C0:16.35,Db0:17.32,D0:18.35,Eb0:19.45,E0:20.6,F0:21.83,Gb0:23.12,G0:24.5,Ab0:25.96,A0:27.5,Bb0:29.14,B0:30.87,C1:32.7,Db1:34.65,D1:36.71,Eb1:38.89,E1:41.2,F1:43.65,Gb1:46.25,G1:49,Ab1:51.91,A1:55,Bb1:58.27,B1:61.74,C2:65.41,Db2:69.3,D2:73.42,Eb2:77.78,E2:82.41,F2:87.31,Gb2:92.5,G2:98,Ab2:103.83,A2:110,Bb2:116.54,B2:123.47,C3:130.81,Db3:138.59,D3:146.83,Eb3:155.56,E3:164.81,F3:174.61,Gb3:185,G3:196,Ab3:207.65,A3:220,Bb3:233.08,B3:246.94,C4:261.63,Db4:277.18,D4:293.66,Eb4:311.13,E4:329.63,F4:349.23,Gb4:369.99,G4:392,Ab4:415.3,A4:440,Bb4:466.16,B4:493.88,C5:523.25,Db5:554.37,D5:587.33,Eb5:622.25,E5:659.25,F5:698.46,Gb5:739.99,G5:783.99,Ab5:830.61,A5:880,Bb5:932.33,B5:987.77,C6:1046.5,Db6:1108.73,D6:1174.66,Eb6:1244.51,E6:1318.51,F6:1396.91,Gb6:1479.98,G6:1567.98,Ab6:1661.22,A6:1760,Bb6:1864.66,B6:1975.53,C7:2093,Db7:2217.46,D7:2349.32,Eb7:2489.02,E7:2637.02,F7:2793.83,Gb7:2959.96,G7:3135.96,Ab7:3322.44,A7:3520,Bb7:3729.31,B7:3951.07,C8:4186.01,Db8:4434.92,D8:4698.63,Eb8:4978.03,E8:5274.04,F8:5587.65,Gb8:5919.91,G8:6271.93,Ab8:6644.88,A8:7040,Bb8:7458.62,B8:7902.13},i=new(window.AudioContext||window.webkitAudioContext||window.audioContext),s=(t,e,s,o,n=!1)=>{let a=t/1e3,r=i.createOscillator(),h=i.createGain();h.connect(i.destination),h.gain.setValueAtTime(0,0),h.gain.linearRampToValueAtTime(o,i.currentTime+.01*a),h.gain.setValueAtTime(o,i.currentTime+a-.4*a),h.gain.linearRampToValueAtTime(0,i.currentTime+a),r.type=s,r.frequency.setValueAtTime(e,0),n&&r.frequency.linearRampToValueAtTime(n,i.currentTime+a),r.start(0),r.stop(i.currentTime+a),r.connect(h)},o=([t,...e],i=.1,n="triangle")=>{if(!t)return;let[a,r]=t;s(a,r,n,i);let h=setTimeout(()=>{clearTimeout(h),o(e,i,n)},a)},n=(t,i)=>t.map((t,s)=>[i[s],e[t]||0]),a=t=>{o(n(["Fb2","F2","Gb2","G2","Ab2","A2","Bb2","B2","Bb2","C3","Db3","D3"],[40,160,40,160,40,160,40,160,40,160,40,160]),.1,"square")},r=t=>{t.gameOver||(s(1500,523.25,"triangle",.1,880),setTimeout(()=>{r(t)},1500))},h=document.getElementById("background").getContext("2d"),l=(t,e)=>{h.fillStyle=B.palette[1],h.textAlign="left",h.fillText(t,50,e)},c=(t,e)=>{h.fillStyle=B.palette[5],0>parseInt(t,10)&&(h.fillStyle=B.palette[4]),h.textAlign="right",h.fillText(`$${t}`,450,e)},p=t=>{let e;let i=JSON.parse(JSON.stringify(B.brain.get("loot")));console.log(i),N(),h.font='14px "Press Start 2P"';let s=y.instances.filter(t=>!t.playerScaped||t.freezed).map(t=>["Enterpreneur caught",-2e3]),o=[["Incoming balance",B.brain.get("balance")],...i,["Daily expenses",-52],...s].map(([t,i],s)=>(e=s,l(t,100+25*s),c(i,100+25*s),i)).reduce((t,e)=>t+e);l("Total",100+(e+3)*25),c(o,100+(e+3)*25),h.fillStyle=B.palette[1],o<0&&(h.textAlign="left",h.fillText('Your "carreer" is over',50,400)),B.brain.set("balance",Math.max(0,o)),setTimeout(()=>{h.textAlign="left",h.fillText("[> Go back",50,450),t.changeTrigger(u(t))},2e3)};let d=-1/0;const u=t=>e=>{new Date().getTime()-d<60||(d=new Date().getTime(),g(e,t))},g=(e,i)=>{e===t.leftKey&&$("./levels/0001",i)},m=document.getElementById("vfx").getContext("2d");class y{constructor(t,e,i,s=!1){this.position={x:e,y:i,flip:!0,inside:!1,col:{x:8,y:32,w:16,h:16}},this.stance="standing",this.active=s,this.ctx=t,this.playerScaped=!1,this.freezed=!1,this.properties={foundMessage:"Intruder found!"},this.x=e,this.y=i,this.clearText=()=>y.clearText(this),y.instances||(y.instances=[]),y.instances.push(this)}static create(...t){return new y(...t)}static getCurrent(){return y.instances.find(t=>t.active)}static clearText(t){if(t.textBound){let e=t.textBound;m.clearRect(e.x-1,e.y-1,e.w+2,e.h+2)}}setBound(){this.bound={x:this.position.x+this.position.col.x,y:this.position.y+this.position.col.y,w:this.position.col.w,h:this.position.col.h}}toggleActivation(){if(this.active=!this.active,this.playerScaped||(this.draw(),!this.active))return;let t=this.position.flip?16:12;this.ctx.beginPath(),this.ctx.rect(this.position.x+t,this.position.y+24,4,4),this.ctx.fillStyle=B.palette[1],this.ctx.fill(),this.ctx.closePath()}return(){if(!this.playerScaped)return;this.playerScaped=!1;let{x:t,y:e}=this;e<20&&(this.y=20),t<100&&(this.x=100),t>400&&(this.x=400),B.displayText("Returned",this),setTimeout(()=>{this.clearText()},1e3)}scaped(t,e){return -24!==t&&504!==t&&-32!==e&&480!==e||(m.fillStyle=B.palette[1],e<20&&(this.y=20),t<100&&(this.x=100),t>400&&(this.x=400),B.displayText("Escaped",this),setTimeout(()=>{this.clearText()},1e3),this.playerScaped=!0,y.instances.forEach(t=>t.toggleActivation()),this.ctx.clearRect(0,0,512,512),y.instances.some(t=>!t.playerScaped)||(B.gameOver=!0,clearInterval(B.timer),p(B.user))),this.playerScaped}move({x:t=this.position.x,y:e=this.position.y},i=!1){if(B.gameOver||this.playerScaped||this.freezed)return;if(this.movement="up",t-this.position.x>0&&(this.movement="right"),t-this.position.x<0&&(this.movement="left"),e-this.position.y>0&&(this.movement="down"),this.setBound(),this.interactingWith&&this.interactingWith.properties.constraints){let{x:t,y:e}=this.interactingWith,i=this.position.x+8,s=this.position.col.y+this.position.y,o="up";if(t<i?o="left":t>i?o="right":e>s&&(o="down"),!this.interactingWith.properties.constraints.includes(this.movement))return this.interactingWith.changeConditions();if("up"===o&&"down"===this.movement||"down"===o&&"up"===this.movement){this.interactingWith.reset(),this.stance="standing",this.draw(),this.interactingWith.draw(),delete this.interactingWith;return}}delete this.interactingWith;let s=B.computePosition(t,e+16);!i&&(this.scaped(t,e)||s.x<1||s.x>32||s.y<2||s.y>32||x.activateObject(t,e)||0!==B.collitionMap[s.collitionIndex])||(this.position.x=t,this.position.y=e,this.x=t,this.y=e,this.width=this.bound.w,B.testTrigger(s.collitionIndex,this),B.testHalt(s.collitionIndex),this.draw())}draw(){this.setBound();let{collitionIndex:t}=B.computePosition(this.position.x,this.position.y);this.position.inside=0!==B.insideMap[t],this.ctx.beginPath(),this.ctx.clearRect(0,0,512,512);let e=32,i=48,s={x:0,y:0},[o,n]={"false,false":[64,80],"true,false":[32,80],"true,true":[32,128],"false,true":[64,128]}[[this.position.flip,this.position.inside].join(",")];"kneeled"===this.stance&&(e=32,i=32,o=0,n=96,this.position.inside&&(n=144),s={x:4,y:8}),this.ctx.drawImage(j,o,n,e,i,this.position.x+s.x,this.position.y+s.y,e,i),A&&(this.ctx.rect(this.bound.x,this.bound.y,this.bound.w,this.bound.h),this.ctx.strokeStyle=B.palette[1],this.ctx.stroke()),this.ctx.closePath(),B.setSight()}}const f=document.getElementById("vfx").getContext("2d");class x{constructor(t){this.ctx=document.getElementById("objects").getContext("2d"),Object.entries(t).forEach(([t,e])=>{this[t]=JSON.parse(JSON.stringify(e))});let e=this.properties;this.state=!!this.state,this.combinationStep=0,this.combinationTicks=0,this.combinationFailed=!1,this.combinationSuccess=!1,this.clearText=()=>x.clearText(this),this.col={x:this.x+e.col.x,y:this.y+e.col.y,w:e.col.w,h:e.col.h},this.collitionIndex=B.computePosition(this.col.x,this.col.y).collitionIndex-1}static setPrototypes(t){x.prototypes=t.filter(({type:t})=>"prototype"===t)}static clearText(t){if(t.textBound){let e=t.textBound;f.clearRect(e.x-1,e.y-1,e.w+2,e.h+2)}}static setObjects(t){t.filter(({type:t})=>"prototype"!==t).forEach(t=>{x.addObject(t)})}static addObject(t){if(t.properties||(t.properties={}),Array.isArray(t.properties)){let e={};t.properties.forEach(({name:t,value:i})=>{e[t]=i}),t.properties=e}x.prototypes.find(e=>e.name===t.type).properties.forEach(({name:e,value:i})=>{t.properties[e]=JSON.parse(i)});let e=new x(t);return x.instances||(x.instances=[]),x.instances.push(e),e.draw(),e}static returnCollition(t,e,i){let s=t+i.bound.w,o=e+i.bound.h;return x.instances.find(i=>{let n=i.col.x,a=i.col.x+i.col.w,r=i.col.y,h=i.col.y+i.col.h;return t<a&&s>n&&e<h&&o>r})}static activateObject(t,e){let i=y.getCurrent(),s=t+i.position.col.x,o=e+i.position.col.y,n=x.returnCollition(s,o,i);if(!n)return!1;if(n.properties.restrictFrom?.includes(i.movement))return;let a={x:32,y:0};return(s<i.position.x+8&&(a.x=-32),o<i.position.y+32&&(a={x:0,y:-48}),o>i.position.y+32&&(a={x:0,y:48}),i.interactingWith=n,!0===n.state&&(n.properties.gateway&&i.move({x:i.position.x+a.x,y:i.position.y+a.y},!0),n.properties.returnState))?(n.setState(!1),n.draw(),!1):(n.properties.interactive&&(i.stance="kneeled",i.draw()),n.properties.changeConditions)?n.changeConditions():(n.state||n.setState(!0),n.draw(),!1)}draw(){"door"===this.type&&B.toggleVisibility(this);let t=this.properties;if(this.ctx.clearRect(this.x,this.y,this.width,this.height),"camera"===this.type){let e=this.state?"":"Alt";t[this.state]=this[`${this.direction}${e}`]}this.ctx.drawImage(j,t[this.state].x,t[this.state].y,this.width,this.height,this.x,this.y,this.width,this.height),"statue"===this.type&&this.statue(),A&&(this.ctx.rect(this.col.x,this.col.y,this.col.w,this.col.h),this.ctx.stroke())}setState(t){"fuse"===this.type&&(B.hasEnergy=!t),!this.state&&t&&["computer","safe","statue"].includes(this.type)&&this.success(),this.state=t,B.triggerSight()}changeConditions(){this[this.type]&&this[this.type]()}success(){let t={computer:[["Cat Pictures",1],["Blackmail evidence",1e3],["Confidential documents",2e3]],safe:[["Some cash",500],["Good cash",1e3],["Very good cash",1500],["Confidential documents",2e3],["Diamonds",3e3]],statue:[["Valuable statue",100],["Limited edition figure",300],["Action figure",70],["Collectable toy",80]]}[this.type];B.brain.loot||B.brain.set("loot",[]);let e=t[~~(t.length*Math.random()|0)];B.brain.push("loot",e)}reset(){this.properties.returnState&&(this.setState(!1),this.draw()),("safe"===this.type||"computer"===this.type)&&(this.combinationStep=0,this.combinationTicks=0,this.combinationFailed=!1,this.booting=!1,this.clearText(),f.clearRect(this.x+8,this.y+4,16,8),"computer"===this.type&&(o(n(["E4","G3"],[60,100]),.4),this.bootingTime&&clearTimeout(this.bootingTime)))}computer(){let t=t=>{let e=["left","up","right"],i=t;for(;i===t;)i=e[Math.floor(Math.random()*e.length)];return i};if(!this.combination){this.combination=[];let e=null;for(let i=0;i<=10;i++){let i=t(e);this.combination.push(i),e=i}}if(this.booting)return;if(0===this.combinationStep){this.booting=!0,this.computerDisplay(),o(n(["G3","E4"],[60,100]),.4),this.bootingTime=setTimeout(()=>{this.combinationStep+=1,this.computerDisplay(),this.booting=!1},1e3);return}let e=y.getCurrent(),i=this.combination[this.combinationStep];if(!i){this.combinationSuccess=!0,this.computerDisplay(),f.fillStyle=B.palette[1],B.displayText("Computer hacked",this),this.setState(!0);return}if(!this.combinationSuccess&&!this.combinationFailed){if(i===e.movement){if(this.combinationStep+=1,!this.combination[this.combinationStep])return this.computer()}else this.combinationFailed=!0;this.computerDisplay()}}statue(){let t=this.properties,e=t[t.variant];this.ctx.clearRect(this.x+4,this.y-4,e.w,e.h),this.state||this.ctx.drawImage(j,e.x,e.y,e.w,e.h,this.x+4,this.y-4,e.w,e.h)}safe(){if(this.combinationFailed)return;if(this.combination||(this.combination=[...Array(Math.round(4*Math.random()+5))].map(t=>Math.round(5*Math.random())+1),this.combination[1]=Math.max(2,this.combination[1])),0===this.combinationStep){this.combinationStep+=1;return}let t=["left","right"][this.combinationStep%2],e=y.getCurrent();if("up"===e.movement&&this.combinationSuccess&&1!==this.combinationStep){this.setState(!0),this.draw();return}if(!this.combinationSuccess||!this.state){if(t===e.movement)this.combinationTicks+=1,b(this.combination,this.combinationStep,this);else{this.combinationFailed=!0,this.combinationSuccess=!1,b(this.combination,this.combinationStep,this),o(n(["E4","","A3"],[60,200,250]),.4);return}this.combination[this.combinationStep]-this.combinationTicks==0?(this.combinationStep+=1,this.combinationTicks=0,b(this.combination,this.combinationStep,this),this.combination[this.combinationStep]&&o(n(["A3"],[60]),.4)):o(n(["A2"],[60]),.4),this.combination[this.combinationStep]||(this.combinationSuccess=!0,b(this.combination,this.combinationStep,this),o(n(["G5"," ","A5"],[50,50,50]),.4))}}computerDisplay(){if(f.clearRect(this.x+8,this.y+4,16,8),f.beginPath(),0===this.combinationStep?f.fillStyle=B.palette[3]:this.combinationFailed?f.fillStyle=B.palette[4]:this.combinationSuccess?f.fillStyle=B.palette[5]:f.fillStyle=B.palette[3],f.rect(this.x+8,this.y+4,16,8),f.fill(),f.closePath(),0===this.combinationStep||this.combinationFailed||this.combinationSuccess)return;f.beginPath(),f.fillStyle=B.palette[5];let t={up:[this.x+12,this.y+4,8,4],left:[this.x+8,this.y+4,4,8],right:[this.x+20,this.y+4,4,8]}[this.combination[this.combinationStep]];f.rect(...t),f.fill(),f.closePath()}}const b=(t,e,i)=>{let s=Array(t.length-1).fill("");s=s.map((i,s)=>s===e-1?"[*]":s>=e-1?"":`[${t[s+1]}]`).filter(t=>""!==t).join(""),f.fillStyle=B.palette[1],i.combinationSuccess&&(f.fillStyle=B.palette[1],s="Safe unlocked"),i.combinationFailed&&(f.fillStyle=B.palette[4]),B.displayText(s,i)},S=document.getElementById("vfx").getContext("2d");class w{constructor(t){this.props=t,this.position={x:t.x,y:t.y},this.canMove=!0,this.width=this.props.width,this.clearText=()=>w.clearText(this),w.instances||(w.instances=[]),w.instances.push(this)}static ctx=document.getElementById("vigilance").getContext("2d");static ctxSight=document.getElementById("light").getContext("2d");static clearText(t){if(t.textBound){let e=t.textBound;S.clearRect(e.x-1,e.y-1,e.w+2,e.h+2)}}static getCamera(t){return w.instances.find(e=>e.id===t)}static getActiveVigilance(){return w.instances.filter(t=>t.props.start).filter(t=>"camera"===t.props.type&&!!B.hasEnergy||"camera"!==t.props.type)}static getAll(){return w.instances}static createAll(t){w.chain=JSON.parse(JSON.stringify(t)).map((t,e,i)=>{let s=t.properties.find(t=>"next"===t.name);if(!s)return t;t.next=s.value,delete t.properties,delete t.name,delete t.rotation,delete t.type,delete t.visible;let o=i.find(t=>t.id===s.value),n="up";return t.x<o.x&&(n="right"),t.x>o.x&&(n="left"),t.y<o.y&&(n="down"),t.direction=n,t}),t.map(t=>{let e=t.properties.find(t=>"start"===t.name);return e?t.start=e.value:t.start=!1,"camera"===t.type&&(t.start=!0),t}).filter(t=>"guard"!==t.type||!!t.start).map(t=>(x.prototypes.find(e=>e.name===t.type).properties.forEach(({name:e,value:i})=>{t[e]=JSON.parse(i)}),t)).forEach(t=>{if("camera"===t.type){let e=t.properties.find(t=>"direction"===t.name).value;t.direction=e,t.start=!0,delete t.properties,t.Object=x.addObject(t)}return new w(t)})}static calculateDistance(t,e,i,s){return Math.sqrt(Math.pow(i-t,2)+Math.pow(s-e,2))}static getInteractingWith({bound:t}){let{x:e,y:i}=t,s=null,o=1/0;return w.instances.filter(t=>"guard"===t.props.type).forEach(t=>{let{x:n,y:a}=t.col,r=w.calculateDistance(e,i,n,a);r<o&&(o=r,s=t)}),s}captureRadius({x:t,y:e,w:i,h:s}){let o=Array(1024).fill(0),n=Math.max(0,Math.floor(e/16)),a=Math.min(32,Math.ceil((e+s)/16)),r=Math.max(0,Math.floor(t/16)),h=Math.min(32,Math.ceil((t+i)/16));for(let t=n;t<a;t++)for(let e=r;e<h;e++)o[32*t+e]=1;B.setTriggers({type:"halt",value:o}),A&&(w.ctxSight.beginPath(),o.forEach((t,e)=>{0!==t&&w.ctxSight.rect(e%32*16,16*Math.floor(e/32),16,16)}),w.ctxSight.fillStyle=`${B.palette[11]}66`,w.ctxSight.fill(),w.ctxSight.closePath())}frame(){if(this.x=this.position.x,this.y=this.position.y,!this.canMove)return this.draw();this.id||(this.id=this.props.id);let t=w.chain.find(t=>t.id===this.id),e=w.chain.find(e=>e.id===t.next)||{};this.direction=t.direction,"right"===this.direction&&Object.assign(this.position,{x:this.position.x+16}),"left"===this.direction&&Object.assign(this.position,{x:this.position.x-16}),"down"===this.direction&&Object.assign(this.position,{y:this.position.y+16}),"up"===this.direction&&Object.assign(this.position,{y:this.position.y-16}),this.col={x:this.position.x-16,y:this.position.y,w:64,h:64},"camera"===this.props.type&&(this.direction=this.props.direction),e.x===this.position.x&&e.y===this.position.y&&(this.id=e.id),this.step=!this.step,this.draw()}draw(){if("camera"===this.props.type)return;let t={true:"Alt",false:""}[!this.step],e=`${this.direction}${t}`,i=w.ctx;return i.beginPath(),i.drawImage(j,this.props[e].x,this.props[e].y,this.props.width,this.props.height,this.position.x,this.position.y,this.props.width,this.props.height),i.closePath(),this.captureRadius(this.col),e}}const v=document.getElementById("sight").getContext("2d"),T=document.getElementById("vfx").getContext("2d"),E=document.getElementById("background").getContext("2d"),[A,M,C]=[!1,!1,!1],B={reset(){this.objects={},this.insideMap=[],this.collitionMap=[],this.alertTrigger=[],this.haltTrigger=[],this.timer=null,this.stepValue=0,this.hasEnergy=!0,this.found=!1,this.police=!1,this.gameOver=!1,y.instances=[],w.instances=[],x.instances=[]},Player:y,Vigilance:w,Obj:x,ticker(){10===this.stepValue&&(this.stepValue=0),this.stepValue+=1,C||o(n([["F2","C2"][this.stepValue%2]],[400])),this.timer&&clearInterval(this.timer),w.ctx.clearRect(0,0,512,512),w.ctxSight.clearRect(0,0,512,512),this.alertTrigger=Array(1024).fill(0),this.haltTrigger=Array(1024).fill(0),w.getActiveVigilance().forEach(t=>{t.frame(),this.generateSight(t)}),y.instances.forEach(t=>{let{x:e,y:i}=t.position,s=B.computePosition(e,i+16);this.testTrigger(s.collitionIndex,t)}),x.instances.filter(t=>!0===t.state).forEach(t=>{let e={x:0,y:0,w:t.width,h:t.height};t.properties.detection&&(e=t.properties.detection);let i=this.multipleComputePosition(t.x+e.x,t.y+e.y,e.w,e.h);A&&(T.beginPath(),T.strokeStyle=this.palette[4],T.rect(t.x+e.x,t.y+e.y,e.w,e.h),T.stroke(),T.closePath()),i.forEach(({collitionIndex:e})=>{this.testTrigger(e,t)})});let t=this.found?400:800,e=new Date().getTime();if(this.found&&e-this.found>5e3&&!this.police&&(r(this),this.police=!0),this.found&&e-this.found>15e3&&!this.gameOver)return this.gameOver=!0,p(this.user),clearInterval(this.timer);if(this.police){E.beginPath();let t=[B.palette[4],B.palette[3]][this.stepValue%2];E.fillStyle=t,E.rect(0,0,512,512),E.fill(),E.closePath()}this.timer=setInterval(()=>{this.ticker()},t)},triggerSight(){w.ctxSight.clearRect(0,0,512,512),w.getActiveVigilance().forEach(t=>{this.generateSight(t)})},multipleComputePosition(t,e,i,s){let o=new Set;for(let n=t;n<t+i;n+=16)for(let t=e;t<e+s;t+=16)o.add(this.computePosition(n,t));return[...o]},computePosition(t,e){let i={x:Math.floor(t/16)+2,y:Math.ceil(e/16)+2};return i.collitionIndex=i.x-1+(i.y-1)*32,i},toggleVisibility(t){let{collitionIndex:e}=this.computePosition(t.x-16,t.y-16);this.obstaclesMap[e]=t.state?0:-1,this.setSight()},generateShadow(t,e){let i=Array(1024).fill(0),s=Math.floor(t%32),o=Math.floor(t/32);for(let t=0;t<32;t++)for(let e=0;e<32;e++){let n=e-s,a=t-o,r=Math.atan2(a,n),h=Math.sqrt(n**2+a**2),l=!1;for(let t=1;t<=h;t++){let e=Math.round(s+t*Math.cos(r)),n=Math.round(o+t*Math.sin(r)),a=32*n+e;if(e>=0&&e<32&&n>=0&&n<32){if(0!==this.obstaclesMap[a]){l||(i[a]=1,l=!0);break}i[a]=1}}}v.clearRect(e.x+8,e.y+16,16,16),i.forEach((t,e)=>{0!==t&&v.clearRect(e%32*16,16*Math.floor(e/32),16,16)}),v.closePath()},generateSight(t){let e;if(t.props.Object?.state)return;let i=this.collitionMap,s=Array(1024).fill(0),[o,n]=[t.position.x,t.position.y];"guard"===t.props.type&&["down","left","up"].includes(t.direction)&&(o-=1),"right"===t.direction&&(e=[330,30]),"down"===t.direction&&(e=[60,120]),"left"===t.direction&&(e=[150,210]),"up"===t.direction&&(e=[240,300]),"camera"===t.props.type&&(["right","left"].includes(t.direction)&&(o-=1),"right"===t.direction&&(e=[0,45]),"left"===t.direction&&(e=[135,180]));let a=this.computePosition(o,n).collitionIndex,r=Math.floor(a%32),h=Math.floor(a/32);for(let t=0;t<32;t++)for(let o=0;o<32;o++){let n=o-r,a=t-h,l=Math.atan2(a,n),c=(180*l/Math.PI+360)%360;if(e[0]<=e[1]?e[0]<=c&&c<=e[1]:c>=e[0]||c<=e[1]){let t=Math.sqrt(n**2+a**2),e=!1;for(let o=1;o<=t;o++){let t=Math.round(r+o*Math.cos(l)),n=Math.round(h+o*Math.sin(l)),a=32*n+t;if(t>=0&&t<32&&n>=0&&n<32){if(0!==i[a]){e||(s[a]=1,e=!0);break}s[a]=1}}}}B.setTriggers({type:"light",value:s}),w.ctxSight.beginPath(),s.forEach((t,e)=>{0!==t&&w.ctxSight.rect(e%32*16,16*Math.floor(e/32),16,16)}),w.ctxSight.fillStyle=`${this.palette[11]}66`,w.ctxSight.fill(),w.ctxSight.closePath()},setTriggers({type:t,value:e}){"light"===t&&e.forEach((t,e)=>{t&&(this.alertTrigger[e]=t)}),"halt"===t&&e.forEach((t,e)=>{t&&(this.haltTrigger[e]=t)})},testTrigger(t,e){this.alertTrigger[t]&&!this.found&&(this.found=new Date().getTime(),a(),T.fillStyle=this.palette[1],this.displayText(e.properties.foundMessage,e),setTimeout(()=>{e.clearText()},3e3))},testHalt(t){if(this.haltTrigger[t]){let t=y.getCurrent();t.freezed=!0;let e=w.getInteractingWith(y.getCurrent());e.canMove=!1;let{x:i,y:s}=t.bound,{x:o,y:n}=e.col,r=o-i,h=n-s;Math.abs(r)>Math.abs(h)?e.direction=r>0?"left":"right":e.direction=h>0?"up":"down",this.found||(this.found=new Date().getTime(),a()),T.fillStyle=this.palette[1],this.displayText("Intruder caught!",e),setTimeout(()=>{e.clearText()},3e3)}},setSight(){if(M)return;let t=y.instances.map(({position:t})=>t);v.beginPath(),v.fillStyle=this.palette[0],v.rect(0,0,512,512),v.fill(),v.closePath(),t.forEach(t=>{this.generateShadow(this.computePosition(t.x,t.y).collitionIndex,t)})},displayText(t,e){e.clearText(),T.font='10px "Press Start 2P"',T.textAlign="center",T.fillText(t,e.x+e.width/2,e.y);let i=T.measureText(t),s=Math.ceil(i.actualBoundingBoxAscent+i.actualBoundingBoxDescent)+2;e.textBound={y:e.y-s,w:i.width,h:s,x:e.x+e.width/2-i.width/2}}},I=document.getElementById("floor").getContext("2d"),P=document.getElementById("walls").getContext("2d"),D=document.getElementById("player1").getContext("2d"),O=document.getElementById("player2").getContext("2d"),k=document.getElementById("overlayer").getContext("2d"),j=new Image;let G=-1/0;const F=t=>{new Date().getTime()-G<60||(G=new Date().getTime(),R(t))},R=e=>{if(B.gameOver)return;let i=y.getCurrent();if(e===t.aKey)y.instances.forEach(t=>t.toggleActivation());else{if(i.frezed)return;switch(e){case t.leftKey:i.position.flip=!0,i.move({x:i.position.x-16});break;case t.rightKey:i.position.flip=!1,i.move({x:i.position.x+16});break;case t.upKey:i.move({y:i.position.y-16});break;case t.downKey:i.move({y:i.position.y+16});break;case t.bKey:y.getCurrent().return(),y.getCurrent().draw()}}},V=(t,e,i="data")=>{let s=t.layers.find(t=>t.name===e);return s?s[i]:[]},K=t=>{let e=(t,e,s)=>"#"+i(t)+i(e)+i(s),i=t=>{let e=t.toString(16);return 1===e.length?"0"+e:e},s=document.createElement("canvas");s.width=t.width,s.height=t.height;let o=s.getContext("2d",{willReadFrequently:!0});o.drawImage(t,0,0,t.width,t.height),B.palette=[];for(let t=4;t<=20;t+=16)for(let i=4;i<=116;i+=16){let s=o.getImageData(i,t,1,1).data,n=e(s[0],s[1],s[2]);B.palette.push(n)}},$=(t,e)=>{e.changeTrigger(F),B.user=e,B.reset(),y.create(D,440,384,!0),y.create(O,-8,32),fetch(`${t}/map.json`).then(t=>(console.log(t),t.json())).then(e=>{let i=e.properties.find(t=>"tileset"===t.name);j.onload=function(){K(j),N(),x.setPrototypes(V(e,"objects","objects")),B.insideMap=V(e,"floor"),B.collitionMap=V(e,"collitions"),B.obstaclesMap=V(e,"obstacles"),x.setObjects(V(e,"objects","objects")),w.createAll(V(e,"vigilance","objects")),y.instances.forEach(t=>t.draw()),e.layers.filter(t=>t.visible&&"tilelayer"===t.type).forEach(t=>{let e=I;"overlayer"===t.name&&(e=k),"walls"===t.name&&(e=P),t.data.forEach((t,i)=>{0!==t&&e.drawImage(j,(t-1)%8*16,16*Math.floor((t-1)/8),16,16,i%32*16,16*Math.floor(i/32),16,16)})}),B.ticker()},j.src=`${t}/${i.value}`})};class W{constructor(){Object.entries(JSON.parse(localStorage.sneaky||"{}")).forEach(([t,e])=>{this[t]=e}),this.balance||(this.balance=0),this.balance=~~this.balance}save(){localStorage.sneaky=JSON.stringify(this)}set(t,e){this[t]=e,this.save()}push(t,e){this[t].push(e),this.save()}get(t){return this[t]}}const J=new class{constructor(e=()=>{}){this.interval=null,this.eventsTrigger=e,document.addEventListener("keydown",({keyCode:t})=>{this.eventsTrigger(t)}),[...document.querySelectorAll(".input")].forEach(e=>{let i=e=>{this.interval=setInterval(()=>{let i=e.target.className.split(" ").filter(t=>"input"!==t)[0];this.eventsTrigger(t[`${i}Key`])},50)},s=t=>{clearInterval(this.interval)};e.addEventListener("touchstart",i),e.addEventListener("touchend",s),e.addEventListener("mousedown",i),e.addEventListener("mouseup",s)}),document.querySelector("body").addEventListener("touchend",t=>{t.preventDefault()})}changeTrigger(t){this.eventsTrigger=t}},N=t=>{B.brain=new W,B.brain.set("loot",[]);let e=document.getElementById("background").getContext("2d");document.querySelectorAll("canvas").forEach(t=>{t.getContext("2d").clearRect(0,0,512,512)}),e.beginPath(),e.rect(0,0,512,512),e.fillStyle=B.palette[0],e.fill(),e.closePath()};$("./levels/0001",J);
//# sourceMappingURL=index.f72c8388.js.map
